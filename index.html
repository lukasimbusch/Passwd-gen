<script>
  // CHANGE THIS LINE to your Render URL:
  const SERVER_URL = "https://passwd-gen.onrender.com";
  let lastPasswords = [];

  // Helper: fetch with timeout
  async function fetchWithTimeout(url, options = {}, timeout = 30000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const res = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(id);
      return res;
    } catch (err) {
      clearTimeout(id);
      throw err;
    }
  }

  async function testServer() {
    const status = document.getElementById("serverStatus");
    status.textContent = "üîÑ Waking server (this can take ~20s)...";
    try {
      const res = await fetchWithTimeout(SERVER_URL + "/", {}, 35000);
      if (res.ok) {
        const text = await res.text();
        status.textContent = "‚úÖ Server is online! (" + text.slice(0, 40) + "...)";
      } else {
        status.textContent = `‚ö†Ô∏è Server responded with ${res.status}`;
      }
    } catch (err) {
      if (err.name === "AbortError") {
        status.textContent = "‚åõ Server didn‚Äôt respond (maybe still waking up). Try again in a few seconds.";
      } else {
        status.textContent = "‚ùå Server not reachable (" + err.message + ")";
      }
    }
  }

  async function generate() {
    const count = +document.getElementById("count").value;
    const minLen = +document.getElementById("min").value;
    const maxLen = +document.getElementById("max").value;
    const out = document.getElementById("output");
    out.textContent = "Generating on server... please wait.";

    try {
      const res = await fetchWithTimeout(`${SERVER_URL}/generate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count, minLen, maxLen })
      }, 60000);

      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      const data = await res.json();
      lastPasswords = data.passwords;
      out.textContent = data.passwords.join("\n");
    } catch (err) {
      out.textContent = "‚ùå Error: " + err.message;
    }
  }

  function download() {
    if (lastPasswords.length === 0) {
      alert("Generate some passwords first!");
      return;
    }
    const blob = new Blob([lastPasswords.join("\n")], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "passwords.txt";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

